# Complete Task and Merge

Finish the current task and integrate changes.

## Instructions

1. Read current task from `.branch-flow/current-task.json`
   - Verify status is "review-passed"
   - If not, prompt to run `/bf:review` first

2. Read configuration from `.branch-flow/config.json`

3. **Pre-merge Verification:**
   ```bash
   # Ensure base branch is up to date
   git fetch origin [baseBranch]
   
   # Check for conflicts
   git merge-base --is-ancestor origin/[baseBranch] HEAD
   ```

4. **Handle Conflicts if Any:**
   - Rebase onto latest base branch
   - Resolve conflicts maintaining our changes where appropriate
   - Re-run tests after resolution

5. **Merge Strategy:**

   **Option A: Direct Merge (if `autoMerge: true`)**
   ```bash
   git checkout [baseBranch]
   git merge --no-ff bf/[spec-id]-[slug] -m "Merge: [Spec Title]"
   git push origin [baseBranch]
   ```

   **Option B: Pull Request (if `prTemplate: true`)**
   
   Create PR with template:
   ```markdown
   ## Summary
   [Description from spec]
   
   ## Changes
   - [List of changes from plan]
   
   ## Testing
   - [x] Unit tests added/updated
   - [x] All tests passing
   - [x] Manual testing completed
   
   ## Checklist
   - [x] Code follows project conventions
   - [x] Documentation updated
   - [x] No breaking changes (or documented)
   
   ## Related
   - Spec: .branch-flow/specs/[spec-file]
   
   ---
   *Generated by Branch Flow*
   ```

6. **Update Memory:**

   Add to `.branch-flow/memory/learnings.md`:
   ```markdown
   ## [Date] - [Spec Title]
   
   ### What Worked
   - [Effective patterns used]
   
   ### Challenges
   - [Difficulties encountered]
   
   ### For Next Time
   - [Recommendations for similar tasks]
   ```
   
   Update `.branch-flow/memory/decisions.md` if significant decisions were made

7. **Archive Spec:**
   
   Update spec status to "completed":
   ```markdown
   **Status:** completed
   **Completed:** [date]
   **Branch:** bf/[spec-id]-[slug]
   **Merged:** [commit hash]
   ```

8. **Cleanup:**
   ```bash
   # Delete feature branch (optional, ask user)
   git branch -d bf/[spec-id]-[slug]
   ```
   
   Clear current-task.json:
   ```json
   {
     "specId": null,
     "status": "idle",
     "lastCompleted": {
       "specId": "001",
       "specFile": "001-feature-name.md",
       "completedAt": "..."
     }
   }
   ```

9. Output:
```
âœ… Task Complete: 001-[name]

ğŸ”€ Merged to: main
ğŸ“ Commit: [hash] "Merge: [Spec Title]"

ğŸ“Š Summary:
   - Files changed: 5
   - Lines added: 210
   - Lines removed: 15
   - Tests added: 8

ğŸ“š Memory Updated:
   - Added learnings from this task
   - Updated project context

ğŸ§¹ Cleanup:
   - Branch bf/001-[slug] deleted
   - Spec marked as completed

ğŸ‰ Ready for next task!
   Run /bf:spec to start a new task
```

Or for PR:
```
âœ… Task Ready for Review: 001-[name]

ğŸ”— Pull Request Created:
   https://github.com/[repo]/pull/[number]
   
   Title: [Spec Title]
   Branch: bf/001-[slug] â†’ main

ğŸ“‹ PR includes:
   - Detailed description from spec
   - Change summary
   - Test checklist

Next: Get PR reviewed and merged, then run /bf:merge --finalize
```

## Post-Merge Hooks

After successful merge, automatically:
1. Update project-context.md if architecture changed
2. Log decision if significant choice was made
3. Archive completed spec with metadata
